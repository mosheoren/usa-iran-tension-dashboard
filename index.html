<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NEON GEO-TENSION // USA ↔ IRAN</title>
<style>
  :root{
    --bg:#05010a; --text: rgba(220,255,245,0.92);
    --muted: rgba(220,255,245,0.62); --muted2: rgba(220,255,245,0.42);
    --grid: rgba(0,255,180,0.06);
    --neonA:#00ffb4; --neonB:#ff00ff; --neonC:#00aaff;
    --warn:#ffe066; --bad:#ff4d6d;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); }
  body{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    padding: 16px;
    background:
      radial-gradient(900px 500px at 12% 0%, rgba(255,0,255,0.14), transparent 55%),
      radial-gradient(900px 500px at 90% 25%, rgba(0,170,255,0.12), transparent 55%),
      radial-gradient(900px 650px at 50% 110%, rgba(0,255,180,0.12), transparent 55%),
      linear-gradient(180deg, rgba(0,255,180,0.03), transparent 30%),
      var(--bg);
  }
  body:before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background: repeating-linear-gradient(to bottom,
      rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px,
      transparent 1px, transparent 3px
    );
    mix-blend-mode: overlay; opacity:0.35;
  }
  .gridBg{
    position:fixed; inset:0; pointer-events:none;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 36px 36px; opacity:0.55;
  }
  .wrap{ max-width: 980px; margin: 0 auto; }
  .row{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  h1{ margin:0; font-size: 22px; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0,255,180,0.25); }
  .small{ color:var(--muted); font-size: 12px; margin-top: 6px; line-height: 1.35; }
  .btn{
    appearance:none; border: 1px solid rgba(0,255,180,0.35);
    background: rgba(0,255,180,0.06); color: var(--text);
    padding: 10px 12px; border-radius: 12px;
    font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase;
    box-shadow: 0 0 18px rgba(0,255,180,0.10), inset 0 0 18px rgba(0,255,180,0.08);
  }
  .btn:active{ transform: scale(0.99); }

  .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px; }
  .card{
    position:relative;
    background: linear-gradient(180deg, rgba(12,8,22,0.85), rgba(8,5,16,0.75));
    border: 1px solid rgba(0,255,180,0.22);
    border-radius: 16px; padding: 14px;
    box-shadow: 0 0 22px rgba(0,255,180,0.10), 0 0 45px rgba(255,0,255,0.06);
    overflow:hidden;
  }
  .card:after{
    content:""; position:absolute; top:-40px; right:-40px; width:120px; height:120px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,180,0.55), transparent 60%);
    transform: rotate(20deg); opacity:0.18;
  }

  .title{ font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase; }
  .muted{ color: var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }

  .pill{
    padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 900;
    letter-spacing: 0.8px; text-transform: uppercase;
    border: 1px solid rgba(0,255,180,0.30);
    background: rgba(0,255,180,0.06);
    box-shadow: inset 0 0 12px rgba(0,255,180,0.10);
  }
  .ok{ color: var(--neonA); border-color: rgba(0,255,180,0.45) !important; }
  .warn{ color: var(--warn); border-color: rgba(255,224,102,0.45) !important; }
  .bad{ color: var(--bad); border-color: rgba(255,77,109,0.45) !important; }

  .big{
    font-size: 46px; font-weight: 950; letter-spacing: -1px; line-height: 1;
    text-shadow: 0 0 18px rgba(0,255,180,0.18), 0 0 28px rgba(0,170,255,0.12);
  }
  .bar{
    height: 12px; background: rgba(0,255,180,0.08); border: 1px solid rgba(0,255,180,0.20);
    border-radius: 999px; overflow:hidden; margin-top: 10px;
    box-shadow: inset 0 0 18px rgba(0,255,180,0.08);
  }
  .fill{
    height:100%; width:0%;
    background: linear-gradient(90deg, rgba(0,255,180,1), rgba(0,170,255,1), rgba(255,0,255,1));
    box-shadow: 0 0 18px rgba(0,255,180,0.25);
  }

  .indGrid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
  @media(min-width:700px){ .indGrid{ grid-template-columns: 1fr 1fr; } }
  .indCard{
    background: rgba(0,255,180,0.04);
    border: 1px solid rgba(0,255,180,0.18);
    border-radius: 14px; padding: 12px;
    box-shadow: inset 0 0 18px rgba(0,255,180,0.06);
  }
  .indTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
  .indName{ font-weight:900; letter-spacing:0.6px; text-transform:uppercase; }
  .indVal{ font-weight:950; }
  .indSub{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
  .indBar{
    height: 10px; background: rgba(0,255,180,0.08); border: 1px solid rgba(0,255,180,0.18);
    border-radius: 999px; overflow:hidden; margin-top: 10px;
  }
  .indFill{
    height:100%; width:0%;
    background: linear-gradient(90deg, #00ffb4, #00aaff, #ff00ff);
    box-shadow: 0 0 16px rgba(255,0,255,0.10);
  }
  .hr{ margin-top:10px; height:1px; background: linear-gradient(90deg, transparent, rgba(0,255,180,0.25), transparent); }
  .blink{ animation: blink 1.3s infinite; }
  @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:0.55} }

  .log{
    font-size:12px;
    color:rgba(220,255,245,0.78);
    background:rgba(0,0,0,0.25);
    border:1px solid rgba(0,255,180,0.14);
    border-radius:12px;
    padding:10px;
    margin-top:10px;
    white-space:pre-wrap;
    line-height:1.35;
  }
</style>
</head>
<body>
<div class="gridBg"></div>

<div class="wrap">
  <div class="row">
    <div>
      <h1>NEON GEO-TENSION // USA ↔ IRAN</h1>
      <div class="small">
        ALL INDICATORS ALWAYS VISIBLE • LIVE WHERE POSSIBLE <span class="blink">▮</span><br>
        (TENSION MONITORING ONLY — NOT MILITARY TIMING/PREDICTION)
      </div>
    </div>
    <button class="btn" onclick="loadAll()">REFRESH</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <div class="title">MAIN TENSION INDEX</div>
          <div class="muted">WEIGHTED BLEND OF ALL SMALL INDICATORS</div>
        </div>
        <div class="pill" id="label">LOADING…</div>
      </div>

      <div style="margin-top:10px" class="big">
        <span id="score">--</span><span style="font-size:16px;font-weight:900;color:var(--muted)">/100</span>
      </div>

      <div class="bar"><div class="fill" id="mainFill"></div></div>

      <div class="hr"></div>
      <div class="muted" style="margin-top:10px" id="explain">DRIVERS: …</div>
      <div class="muted" style="margin-top:6px" id="riseDays">DAYS IN RISING TENSION: --</div>
      <div class="muted" style="margin-top:6px;color:var(--muted2)" id="statusLine">STATUS: …</div>

      <div class="log" id="logBox">LOG: ready</div>
    </div>

    <div class="card">
      <div class="title">ALL INDICATORS</div>
      <div class="muted" id="queryLine">QUERY: …</div>
      <div class="indGrid" id="indicators"></div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const CORE_QUERY = '"United States" Iran';

  const KW_ESCALATION = ["strike","retaliation","missile","drone","airstrike","attack","bombardment"];
  const KW_SANCTIONS  = ["sanction","designated","designation","OFAC","Treasury","blacklist"];
  const KW_NUCLEAR    = ["IAEA","enrichment","uranium","nuclear","centrifuge","JCPOA"];
  const KW_SPILLOVER  = ["militia","rocket","proxy","Red Sea","Houthis","Hezbollah","Syria","Iraq"];
  const KW_DIPLOMACY  = ["talks","negotiations","diplomacy","agreement","deal","dialogue","ceasefire"];

  // Travel advisory XML: often blocked by browser CORS; we use a proxy.
  const TRAVEL_ADVISORY_XML =
    "https://cadatacatalog.state.gov/dataset/4a387c35-29cb-4902-b91d-3da0dc02e4b2/resource/4c727464-8e6f-4536-b0a5-0a343dc6c7ff/download/traveladvisory.xml";

  const USE_CORS_PROXY = true;
  const CORS_RAW = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

  const AUTO_REFRESH = true;
  const REFRESH_MS = 5 * 60 * 1000;

  // ===== UTIL =====
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function avg(arr){ return arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length); }
  function nowStr(){ return new Date().toLocaleString(); }

  function log(msg){
    const el = document.getElementById("logBox");
    el.textContent = `LOG @ ${nowStr()}\n` + msg;
  }

  function labelFor(s){
    if(s<25) return ["LOW","ok"];
    if(s<50) return ["GUARDED","warn"];
    if(s<75) return ["ELEVATED","warn"];
    return ["HIGH","bad"];
  }

  function daysInRising(history){
    let d = 0;
    for(let i=history.length-1; i>0; i--){
      if(history[i] >= history[i-1]) d++;
      else break;
    }
    return d;
  }

  // ===== RENDER =====
  function renderIndicator(container, ind){
    const el = document.createElement("div");
    el.className = "indCard";
    el.innerHTML = `
      <div class="indTop">
        <div>
          <div class="indName">${ind.name}</div>
          <div class="indSub">${ind.desc}</div>
        </div>
        <div class="indVal">${ind.value}/100</div>
      </div>
      <div class="indBar"><div class="indFill" style="width:${ind.value}%"></div></div>
      <div class="indSub" style="margin-top:8px;color:rgba(220,255,245,.78)">${ind.detail}</div>
    `;
    container.appendChild(el);
  }

  function computeMainIndex(indicators){
    let w=0, s=0;
    for(const i of indicators){ w += i.weight; s += i.value*i.weight; }
    return w ? Math.round(s/w) : 0;
  }

  // ===== LIVE SOURCES =====
  async function fetchGdeltTimeline(query){
    const q = encodeURIComponent(query);
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${q}&mode=timeline&format=json&timelinesmooth=0`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("GDELT_FAILED");
    const j = await res.json();
    const tl = j.timeline || [];
    return tl.map(x => ({date:x.date, value:x.value})).slice(-30);
  }

  function trendPct(days){
    const vals = days.map(d=>d.value);
    const last7 = vals.slice(-7);
    const prev7 = vals.slice(-14,-7);
    const a = avg(last7), b = avg(prev7);
    if(!isFinite(a)||!isFinite(b)||b===0) return 0;
    return ((a-b)/b)*100;
  }

  function scoreVolume(v){ return Math.round(clamp((v - 10) / 190, 0, 1) * 100); }
  function scoreTrend(p){ return Math.round(clamp((p + 50) / 150, 0, 1) * 100); }

  function scoreSpike(days){
    const vals = days.map(d=>d.value);
    const last3 = vals.slice(-3);
    const prev7 = vals.slice(-10,-3);
    const a = avg(last3), b = avg(prev7);
    if(!isFinite(a)||!isFinite(b)||b===0) return 0;
    const pct = ((a-b)/b)*100;
    return Math.round(clamp(pct/150, 0, 1) * 100);
  }

  async function keywordPressure(coreQuery, kwList, scaleTop){
    const kwQuery = `${coreQuery} (${kwList.map(k=>`"${k}"`).join(" OR ")})`;
    const days = await fetchGdeltTimeline(kwQuery);
    const today = days.length ? days[days.length-1].value : 0;
    const score = Math.round(clamp(today/scaleTop, 0, 1) * 100);
    return {score, today, ok:true};
  }

  async function fetchIranTravelAdvisory(){
    const url = USE_CORS_PROXY ? CORS_RAW(TRAVEL_ADVISORY_XML) : TRAVEL_ADVISORY_XML;
    const res = await fetch(url);
    if(!res.ok) throw new Error("TRAVEL_XML_FAILED");
    const xmlText = await res.text();
    const doc = new DOMParser().parseFromString(xmlText, "application/xml");

    // best-effort parse: search text blocks containing "Iran" and "Level"
    const nodes = Array.from(doc.getElementsByTagName("*"));
    for(const node of nodes){
      const t = (node.textContent || "").trim();
      if(!t) continue;
      if(t === "Iran" || t === "IRAN" || t.includes("Iran")){
        const p = node.parentElement || node.parentNode;
        if(!p) continue;
        const txt = (p.textContent || "");
        const m = txt.match(/Level\s*([1-4])/i);
        if(m){
          const level = parseInt(m[1],10);
          return { level, ok:true };
        }
      }
    }
    return { level: null, ok:false };
  }

  // ===== DEMO FALLBACKS (ALWAYS VISIBLE) =====
  function demoScore(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // ===== MAIN LOAD =====
  async function loadAll(){
    document.getElementById("queryLine").textContent = "QUERY: " + CORE_QUERY;
    document.getElementById("statusLine").textContent = "STATUS: LOADING…";
    log("starting refresh…");

    const listEl = document.getElementById("indicators");
    listEl.innerHTML = "";

    // We collect indicators even if some fail
    const indicators = [];
    const notes = [];

    // 1) Core news
    let daysCore = null;
    try{
      daysCore = await fetchGdeltTimeline(CORE_QUERY);
      const volNow = daysCore.length ? daysCore[daysCore.length-1].value : 0;
      const tPct = trendPct(daysCore);
      const spike = scoreSpike(daysCore);

      indicators.push({
        name:"NEWS VOLUME (GDELT)",
        desc:"public article intensity",
        value: scoreVolume(volNow),
        weight: 0.18,
        detail:`LIVE • today ≈ ${volNow} (timeline units)`
      });

      indicators.push({
        name:"NEWS TREND",
        desc:"last 7d vs prior 7d",
        value: scoreTrend(tPct),
        weight: 0.12,
        detail:`LIVE • trend ${(tPct>=0?"+":"")}${tPct.toFixed(0)}%`
      });

      indicators.push({
        name:"ATTENTION SPIKE",
        desc:"surge detector (3d vs prior week)",
        value: spike,
        weight: 0.10,
        detail:`LIVE • spike score from volume surge`
      });

      // Days in rising tension (based on daily volume score history)
      const hist = daysCore.map(d => scoreVolume(d.value));
      document.getElementById("riseDays").textContent = `DAYS IN RISING TENSION: ${daysInRising(hist)}`;

      notes.push("core news: LIVE OK");
    }catch(e){
      // fallback core indicators
      indicators.push({name:"NEWS VOLUME",desc:"public article intensity",value:demoScore(25,75),weight:0.18,detail:"DEGRADED • live fetch blocked"});
      indicators.push({name:"NEWS TREND",desc:"last 7d vs prior 7d",value:demoScore(20,80),weight:0.12,detail:"DEGRADED • live fetch blocked"});
      indicators.push({name:"ATTENTION SPIKE",desc:"surge detector",value:demoScore(10,70),weight:0.10,detail:"DEGRADED • live fetch blocked"});
      document.getElementById("riseDays").textContent = "DAYS IN RISING TENSION: (degraded)";
      notes.push("core news: DEGRADED (GDELT blocked)");
    }

    // 2) Keyword buckets (each independently)
    async function addKW(name, desc, kws, scaleTop, weight){
      try{
        const r = await keywordPressure(CORE_QUERY, kws, scaleTop);
        indicators.push({
          name, desc, value:r.score, weight,
          detail:`LIVE • today ≈ ${r.today} (keywords)`
        });
        notes.push(`${name}: LIVE OK`);
      }catch(e){
        indicators.push({
          name, desc, value:demoScore(10,80), weight,
          detail:"DEGRADED • live fetch blocked"
        });
        notes.push(`${name}: DEGRADED`);
      }
    }

    await addKW("ESCALATION PRESSURE", "strike / missile / drone language", KW_ESCALATION, 80, 0.16);
    await addKW("SANCTIONS PRESSURE", "sanctions / OFAC / designation language", KW_SANCTIONS, 60, 0.12);
    await addKW("NUCLEAR PRESSURE", "IAEA / enrichment / uranium language", KW_NUCLEAR, 60, 0.12);
    await addKW("REGIONAL SPILLOVER", "proxy / rocket / Red Sea language", KW_SPILLOVER, 80, 0.10);

    // Diplomacy reduces tension, so we invert
    try{
      const d = await keywordPressure(CORE_QUERY, KW_DIPLOMACY, 80);
      const inv = 100 - d.score;
      indicators.push({
        name:"DIPLOMACY (INVERSE)",
        desc:"talks signal (more talks = lower tension)",
        value: inv,
        weight: 0.06,
        detail:`LIVE • talks ${d.score}/100 → inverted`
      });
      notes.push("DIPLOMACY: LIVE OK");
    }catch(e){
      indicators.push({
        name:"DIPLOMACY (INVERSE)",
        desc:"talks signal (more talks = lower tension)",
        value: demoScore(15,85),
        weight: 0.06,
        detail:"DEGRADED • live fetch blocked"
      });
      notes.push("DIPLOMACY: DEGRADED");
    }

    // 3) Travel advisory (independent, optional)
    try{
      const ta = await fetchIranTravelAdvisory();
      const travelScore = ta.level ? Math.round(((ta.level-1)/3)*100) : 50;
      indicators.push({
        name:"TRAVEL ADVISORY (IRAN)",
        desc:"State Dept level mapped to 0–100",
        value: travelScore,
        weight: 0.04,
        detail:`LIVE • level: ${ta.level ?? "unknown"}`
      });
      notes.push("TRAVEL ADVISORY: LIVE OK");
    }catch(e){
      indicators.push({
        name:"TRAVEL ADVISORY (IRAN)",
        desc:"State Dept level mapped to 0–100",
        value: 60,
        weight: 0.04,
        detail:"DEGRADED • XML/CORS blocked"
      });
      notes.push("TRAVEL ADVISORY: DEGRADED (CORS)");
    }

    // Render ALL indicators no matter what
    indicators.forEach(i => renderIndicator(listEl, i));

    // Compute main
    const main = computeMainIndex(indicators);
    const [lbl, cls] = labelFor(main);

    const labelEl = document.getElementById("label");
    labelEl.textContent = lbl;
    labelEl.className = "pill " + cls;

    document.getElementById("score").textContent = main;
    document.getElementById("mainFill").style.width = main + "%";

    // Explain top drivers
    const contrib = indicators.map(i=>({name:i.name, points:i.value*i.weight}))
      .sort((a,b)=>b.points-a.points);

    document.getElementById("explain").textContent =
      `DRIVERS: ${contrib[0].name} + ${contrib[1].name}`;

    // Status
    const degraded = notes.some(n => n.includes("DEGRADED"));
    document.getElementById("statusLine").textContent =
      degraded ? `STATUS: DEGRADED (some sources blocked) • UPDATED ${nowStr()}`
               : `STATUS: LIVE OK • UPDATED ${nowStr()}`;

    log(notes.join("\n"));
  }

  loadAll();
  if(AUTO_REFRESH) setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>