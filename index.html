<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NEON GEO-TENSION // USA ↔ IRAN</title>
<style>
  :root{
    --bg:#05010a; --text: rgba(220,255,245,0.92);
    --muted: rgba(220,255,245,0.62); --muted2: rgba(220,255,245,0.42);
    --grid: rgba(0,255,180,0.06);
    --neonA:#00ffb4; --neonB:#ff00ff; --neonC:#00aaff;
    --warn:#ffe066; --bad:#ff4d6d;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); }
  body{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    padding: 16px;
    background:
      radial-gradient(900px 500px at 12% 0%, rgba(255,0,255,0.14), transparent 55%),
      radial-gradient(900px 500px at 90% 25%, rgba(0,170,255,0.12), transparent 55%),
      radial-gradient(900px 650px at 50% 110%, rgba(0,255,180,0.12), transparent 55%),
      linear-gradient(180deg, rgba(0,255,180,0.03), transparent 30%),
      var(--bg);
  }
  body:before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background: repeating-linear-gradient(to bottom,
      rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px,
      transparent 1px, transparent 3px
    );
    mix-blend-mode: overlay; opacity:0.35;
  }
  .gridBg{
    position:fixed; inset:0; pointer-events:none;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 36px 36px; opacity:0.55;
  }
  .wrap{ max-width: 980px; margin: 0 auto; }
  .row{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  h1{ margin:0; font-size: 22px; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0,255,180,0.25); }
  .small{ color:var(--muted); font-size: 12px; margin-top: 6px; line-height: 1.35; }
  .btn{
    appearance:none; border: 1px solid rgba(0,255,180,0.35);
    background: rgba(0,255,180,0.06); color: var(--text);
    padding: 10px 12px; border-radius: 12px;
    font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase;
    box-shadow: 0 0 18px rgba(0,255,180,0.10), inset 0 0 18px rgba(0,255,180,0.08);
  }
  .btn:active{ transform: scale(0.99); }

  .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px; }
  .card{
    position:relative;
    background: linear-gradient(180deg, rgba(12,8,22,0.85), rgba(8,5,16,0.75));
    border: 1px solid rgba(0,255,180,0.22);
    border-radius: 16px; padding: 14px;
    box-shadow: 0 0 22px rgba(0,255,180,0.10), 0 0 45px rgba(255,0,255,0.06);
    overflow:hidden;
  }
  .card:after{
    content:""; position:absolute; top:-40px; right:-40px; width:120px; height:120px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,180,0.55), transparent 60%);
    transform: rotate(20deg); opacity:0.18;
  }
  .title{ font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase; }
  .muted{ color: var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }

  .pill{
    padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 900;
    letter-spacing: 0.8px; text-transform: uppercase;
    border: 1px solid rgba(0,255,180,0.30);
    background: rgba(0,255,180,0.06);
    box-shadow: inset 0 0 12px rgba(0,255,180,0.10);
  }
  .ok{ color: var(--neonA); border-color: rgba(0,255,180,0.45) !important; }
  .warn{ color: var(--warn); border-color: rgba(255,224,102,0.45) !important; }
  .bad{ color: var(--bad); border-color: rgba(255,77,109,0.45) !important; }

  .big{
    font-size: 46px; font-weight: 950; letter-spacing: -1px; line-height: 1;
    text-shadow: 0 0 18px rgba(0,255,180,0.18), 0 0 28px rgba(0,170,255,0.12);
  }
  .bar{
    height: 12px; background: rgba(0,255,180,0.08); border: 1px solid rgba(0,255,180,0.20);
    border-radius: 999px; overflow:hidden; margin-top: 10px;
    box-shadow: inset 0 0 18px rgba(0,255,180,0.08);
  }
  .fill{
    height:100%; width:0%;
    background: linear-gradient(90deg, rgba(0,255,180,1), rgba(0,170,255,1), rgba(255,0,255,1));
    box-shadow: 0 0 18px rgba(0,255,180,0.25);
  }

  .indGrid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
  @media(min-width:700px){ .indGrid{ grid-template-columns: 1fr 1fr; } }
  .indCard{
    background: rgba(0,255,180,0.04);
    border: 1px solid rgba(0,255,180,0.18);
    border-radius: 14px; padding: 12px;
    box-shadow: inset 0 0 18px rgba(0,255,180,0.06);
  }
  .indTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
  .indName{ font-weight:900; letter-spacing:0.6px; text-transform:uppercase; }
  .indVal{ font-weight:950; }
  .indSub{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
  .indBar{
    height: 10px; background: rgba(0,255,180,0.08); border: 1px solid rgba(0,255,180,0.18);
    border-radius: 999px; overflow:hidden; margin-top: 10px;
  }
  .indFill{
    height:100%; width:0%;
    background: linear-gradient(90deg, #00ffb4, #00aaff, #ff00ff);
    box-shadow: 0 0 16px rgba(255,0,255,0.10);
  }
  .hr{ margin-top:10px; height:1px; background: linear-gradient(90deg, transparent, rgba(0,255,180,0.25), transparent); }
  .blink{ animation: blink 1.3s infinite; }
  @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:0.55} }
  ul{ margin: 8px 0 0 0; padding-left: 18px; }
  li{ color: rgba(220,255,245,0.78); font-size: 13px; line-height: 1.45; margin: 6px 0; }
</style>
</head>
<body>
<div class="gridBg"></div>

<div class="wrap">
  <div class="row">
    <div>
      <h1>NEON GEO-TENSION // USA ↔ IRAN</h1>
      <div class="small">
        LIVE PUBLIC SIGNALS (NEWS + OFFICIAL ADVISORY) <span class="blink">▮</span><br>
        THIS IS A TENSION DASHBOARD — NOT A MILITARY FORECAST TOOL.
      </div>
    </div>
    <button class="btn" onclick="loadAll()">REFRESH</button>
  </div>

  <div class="grid">

    <div class="card">
      <div class="row">
        <div>
          <div class="title">MAIN TENSION INDEX</div>
          <div class="muted">WEIGHTED BLEND OF ALL INDICATORS BELOW</div>
        </div>
        <div class="pill" id="label">LOADING…</div>
      </div>

      <div style="margin-top:10px" class="big">
        <span id="score">--</span><span style="font-size:16px;font-weight:900;color:var(--muted)">/100</span>
      </div>

      <div class="bar"><div class="fill" id="mainFill"></div></div>

      <div class="hr"></div>
      <div class="muted" style="margin-top:10px" id="explain">DRIVERS: …</div>
      <div class="muted" style="margin-top:6px" id="riseDays">DAYS IN RISING TENSION: --</div>
      <div class="muted" style="margin-top:6px;color:var(--muted2)" id="statusLine">STATUS: …</div>
    </div>

    <div class="card">
      <div class="title">ALL INDICATORS (ONE PAGE)</div>
      <div class="muted" id="queryLine">QUERY: …</div>
      <div class="indGrid" id="indicators"></div>
    </div>

    <div class="card">
      <div class="title">NOTES</div>
      <div class="muted">
        Indicators are news + official advisory signals. No pizza logistics, no ship/aircraft tracking.
      </div>
      <ul>
        <li>LIVE: GDELT news-based indicators.</li>
        <li>LIVE: State Dept Travel Advisory level for Iran (from traveladvisory.xml).</li>
        <li>Auto-refresh is ON by default (every 5 minutes).</li>
      </ul>
    </div>

  </div>
</div>

<script>
  // ===== CONFIG =====
  const CORE_QUERY = '"United States" Iran';

  // Keyword buckets (news-based)
  const KW_ESCALATION = ["strike","retaliation","missile","drone","airstrike","attack","bombardment"];
  const KW_SANCTIONS   = ["sanction","designated","designation","OFAC","Treasury","blacklist","entity list"];
  const KW_NUCLEAR     = ["IAEA","enrichment","uranium","nuclear","centrifuge","JCPOA"];
  const KW_SPILLOVER   = ["militia","rocket","proxy","Red Sea","Houthis","Hezbollah","Syria","Iraq"];
  const KW_DIPLOMACY   = ["talks","negotiations","diplomacy","agreement","deal","dialogue","ceasefire"];

  // Auto-refresh
  const AUTO_REFRESH = true;
  const REFRESH_MS = 5 * 60 * 1000;

  // Travel advisory XML for all countries (official dataset mirror)
  const TRAVEL_ADVISORY_XML =
    "https://cadatacatalog.state.gov/dataset/4a387c35-29cb-4902-b91d-3da0dc02e4b2/resource/4c727464-8e6f-4536-b0a5-0a343dc6c7ff/download/traveladvisory.xml";

  // Use a CORS proxy for XML if your browser blocks it:
  // allOrigins raw endpoint
  const USE_CORS_PROXY = true;
  const CORS_RAW = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

  // ===== HELPERS =====
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function avg(arr){ return arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length); }
  function labelFor(s){
    if(s<25) return ["LOW","ok"];
    if(s<50) return ["GUARDED","warn"];
    if(s<75) return ["ELEVATED","warn"];
    return ["HIGH","bad"];
  }
  function daysInRising(history){
    let d = 0;
    for(let i=history.length-1; i>0; i--){
      if(history[i] >= history[i-1]) d++;
      else break;
    }
    return d;
  }

  // GDELT Doc API timeline
  async function fetchGdeltTimeline(query){
    const q = encodeURIComponent(query);
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${q}&mode=timeline&format=json&timelinesmooth=0`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("GDELT_FAILED");
    const j = await res.json();
    const tl = j.timeline || [];
    return tl.map(x => ({date:x.date, value:x.value})).slice(-30);
  }

  function trendPct(days){
    const vals = days.map(d=>d.value);
    const last7 = vals.slice(-7);
    const prev7 = vals.slice(-14,-7);
    const a = avg(last7), b = avg(prev7);
    if(!isFinite(a)||!isFinite(b)||b===0) return 0;
    return ((a-b)/b)*100;
  }

  // Normalize counts → 0..100
  // Note: GDELT timeline values are already normalized shares, but we still map into a UI range.
  function scoreVolume(v){ return Math.round(clamp((v - 10) / 190, 0, 1) * 100); }
  function scoreTrend(p){ return Math.round(clamp((p + 50) / 150, 0, 1) * 100); }

  function scoreSpike(days){
    const vals = days.map(d=>d.value);
    const last3 = vals.slice(-3);
    const prev7 = vals.slice(-10,-3);
    const a = avg(last3), b = avg(prev7);
    if(!isFinite(a)||!isFinite(b)||b===0) return 0;
    const pct = ((a-b)/b)*100; // 0..?
    return Math.round(clamp(pct/150, 0, 1) * 100);
  }

  async function keywordPressureScore(coreQuery, kwList, scaleTop=80){
    const kwQuery = `${coreQuery} (${kwList.map(k=>`"${k}"`).join(" OR ")})`;
    const days = await fetchGdeltTimeline(kwQuery);
    const v = days.length ? days[days.length-1].value : 0;
    const s = Math.round(clamp(v/scaleTop, 0, 1) * 100);
    return {score:s, today:v, days};
  }

  async function fetchIranTravelAdvisory(){
    const url = USE_CORS_PROXY ? CORS_RAW(TRAVEL_ADVISORY_XML) : TRAVEL_ADVISORY_XML;
    const res = await fetch(url);
    if(!res.ok) throw new Error("TRAVEL_XML_FAILED");
    const xmlText = await res.text();
    const doc = new DOMParser().parseFromString(xmlText, "application/xml");

    // try common patterns: look for Iran node by country name
    const all = Array.from(doc.getElementsByTagName("*"));
    // find element that contains "Iran" text and has a "level" nearby
    let level = null, updated = null;

    // Many feeds have entries per country; do a best-effort parse:
    // Look for nodes where textContent includes "Iran" and then search inside parent for "level"
    for(const node of all){
      const t = (node.textContent || "").trim();
      if(t === "Iran" || t === "IRAN" || t.includes("Iran")){
        const p = node.parentElement || node.parentNode;
        if(!p) continue;
        const txt = (p.textContent || "");
        // try to extract advisory level 1-4
        const m = txt.match(/Level\s*([1-4])/i) || txt.match(/\b([1-4])\b.*(Do not travel|Reconsider travel|Exercise increased caution|Exercise normal precautions)/i);
        if(m){
          level = parseInt(m[1],10);
          // try to find a date in the parent block
          const dm = txt.match(/(\bJanuary\b|\bFebruary\b|\bMarch\b|\bApril\b|\bMay\b|\bJune\b|\bJuly\b|\bAugust\b|\bSeptember\b|\bOctober\b|\bNovember\b|\bDecember\b)\s+\d{1,2},\s+\d{4}/i);
          if(dm) updated = dm[0];
          break;
        }
      }
    }

    // If best-effort fails, still return null safely
    return { level, updated };
  }

  function renderIndicator(container, ind){
    const el = document.createElement("div");
    el.className = "indCard";
    el.innerHTML = `
      <div class="indTop">
        <div>
          <div class="indName">${ind.name}</div>
          <div class="indSub">${ind.desc}</div>
        </div>
        <div class="indVal">${ind.value}/100</div>
      </div>
      <div class="indBar"><div class="indFill" style="width:${ind.value}%"></div></div>
      <div class="indSub" style="margin-top:8px;color:rgba(220,255,245,.78)">${ind.detail}</div>
    `;
    container.appendChild(el);
  }

  function computeMainIndex(indicators){
    let w=0, s=0;
    for(const i of indicators){ w += i.weight; s += i.value * i.weight; }
    return w ? Math.round(s/w) : 0;
  }

  async function loadAll(){
    document.getElementById("queryLine").textContent = "QUERY: " + CORE_QUERY;
    document.getElementById("statusLine").textContent = "STATUS: FETCHING LIVE SIGNALS…";
    const listEl = document.getElementById("indicators");
    listEl.innerHTML = "";

    try{
      // Core
      const daysCore = await fetchGdeltTimeline(CORE_QUERY);
      const volNow = daysCore.length ? daysCore[daysCore.length-1].value : 0;
      const tPct = trendPct(daysCore);
      const spike = scoreSpike(daysCore);

      // Keyword buckets
      const esc = await keywordPressureScore(CORE_QUERY, KW_ESCALATION, 80);
      const san = await keywordPressureScore(CORE_QUERY, KW_SANCTIONS,   60);
      const nuc = await keywordPressureScore(CORE_QUERY, KW_NUCLEAR,     60);
      const spi = await keywordPressureScore(CORE_QUERY, KW_SPILLOVER,   80);
      const dip = await keywordPressureScore(CORE_QUERY, KW_DIPLOMACY,   80);

      // Travel advisory (Iran)
      const ta = await fetchIranTravelAdvisory();
      // Map Level 1-4 to 0-100 (Level 4 highest tension)
      const travelScore = (ta.level ? Math.round(((ta.level-1)/3)*100) : 50);

      // Build indicator list (0-100)
      // Diplomacy reduces tension, so we invert it in the main index.
      const diplomacyReduced = 100 - dip.score;

      const indicators = [
        {name:"NEWS VOLUME (GDELT)", desc:"PUBLIC ARTICLE INTENSITY", value: scoreVolume(volNow), weight:0.18,
         detail:`TODAY ≈ ${volNow} (GDELT timeline units)`},
        {name:"NEWS TREND", desc:"LAST 7D VS PRIOR 7D", value: scoreTrend(tPct), weight:0.12,
         detail:`TREND: ${(tPct>=0?"+":"")}${tPct.toFixed(0)}%`},
        {name:"ATTENTION SPIKE", desc:"SURGE DETECTOR (3D VS PRIOR WEEK)", value: spike, weight:0.10,
         detail:`NEWS SURGE SCORE`},

        {name:"ESCALATION PRESSURE", desc:"STRIKE / MISSILE / DRONE LANGUAGE", value: esc.score, weight:0.16,
         detail:`TODAY ≈ ${esc.today} (keywords)`},

        {name:"SANCTIONS PRESSURE", desc:"SANCTIONS / DESIGNATIONS LANGUAGE", value: san.score, weight:0.12,
         detail:`TODAY ≈ ${san.today} (keywords)`},

        {name:"NUCLEAR PRESSURE", desc:"IAEA / ENRICHMENT / URANIUM LANGUAGE", value: nuc.score, weight:0.12,
         detail:`TODAY ≈ ${nuc.today} (keywords)`},

        {name:"REGIONAL SPILLOVER", desc:"PROXY / ROCKET / RED SEA LANGUAGE", value: spi.score, weight:0.10,
         detail:`TODAY ≈ ${spi.today} (keywords)`},

        {name:"DIPLOMACY (INVERSE)", desc:"TALKS SIGNAL (HIGH TALKS = LOWER TENSION)", value: diplomacyReduced, weight:0.06,
         detail:`TALKS SIGNAL: ${dip.score}/100 → INVERTED FOR MAIN INDEX`},

        {name:"TRAVEL ADVISORY (IRAN)", desc:"STATE DEPT ADVISORY LEVEL → 0–100", value: travelScore, weight:0.04,
         detail:`LEVEL: ${ta.level ?? "UNKNOWN"} ${ta.updated ? "• " + ta.updated : ""}`}
      ];

      // Render
      indicators.forEach(i=>renderIndicator(listEl,i));

      // Main score
      const main = computeMainIndex(indicators);
      const [lbl, cls] = labelFor(main);
      const labelEl = document.getElementById("label");
      labelEl.textContent = lbl;
      labelEl.className = "pill " + cls;

      document.getElementById("score").textContent = main;
      document.getElementById("mainFill").style.width = main + "%";

      // Days in rising tension (derive a simple daily main history from core series + current bucket ratios)
      // We approximate daily history using core daily volume score as the baseline driver.
      const coreHist = daysCore.map(d => scoreVolume(d.value));
      const rise = daysInRising(coreHist);
      document.getElementById("riseDays").textContent = `DAYS IN RISING TENSION: ${rise}`;

      const contrib = indicators.map(i=>({name:i.name, points:i.value*i.weight}))
        .sort((a,b)=>b.points-a.points);
      document.getElementById("explain").textContent =
        `DRIVERS: ${contrib[0].name} + ${contrib[1].name}`;

      document.getElementById("statusLine").textContent =
        `STATUS: LIVE OK • UPDATED ${new Date().toLocaleString()}`;

    }catch(e){
      document.getElementById("statusLine").textContent =
        "STATUS: LIVE FAILED (NETWORK/CORS). TRY AGAIN OR SWITCH NETWORK.";
      document.getElementById("label").textContent = "DEGRADED";
      document.getElementById("label").className = "pill warn";
      document.getElementById("score").textContent = "--";
      document.getElementById("mainFill").style.width = "0%";
      document.getElementById("explain").textContent = "DRIVERS: --";
      document.getElementById("riseDays").textContent = "DAYS IN RISING TENSION: --";
    }
  }

  loadAll();
  if(AUTO_REFRESH) setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>
