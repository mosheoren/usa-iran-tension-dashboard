<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NEON TENSION // USA ↔ IRAN</title>
<style>
  :root{
    --bg:#05010a;
    --text: rgba(220,255,245,0.92);
    --muted: rgba(220,255,245,0.62);
    --muted2: rgba(220,255,245,0.42);
    --grid: rgba(0,255,180,0.06);
    --neonA:#00ffb4;
    --neonB:#ff00ff;
    --neonC:#00aaff;
    --warn:#ffe066;
    --bad:#ff4d6d;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); }
  body{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    padding: 16px;
    background:
      radial-gradient(900px 500px at 12% 0%, rgba(255,0,255,0.14), transparent 55%),
      radial-gradient(900px 500px at 90% 25%, rgba(0,170,255,0.12), transparent 55%),
      radial-gradient(900px 650px at 50% 110%, rgba(0,255,180,0.12), transparent 55%),
      linear-gradient(180deg, rgba(0,255,180,0.03), transparent 30%),
      var(--bg);
  }
  body:before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background: repeating-linear-gradient(to bottom,
      rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px,
      transparent 1px, transparent 3px
    );
    mix-blend-mode: overlay; opacity:0.35;
  }
  .gridBg{
    position:fixed; inset:0; pointer-events:none;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 36px 36px; opacity:0.55;
  }
  .wrap{ max-width: 980px; margin: 0 auto; }
  .row{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }

  h1{ margin:0; font-size:22px; letter-spacing:1px; text-shadow: 0 0 10px rgba(0,255,180,0.25); }
  .small{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35; }

  .btn{
    appearance:none; border: 1px solid rgba(0,255,180,0.35);
    background: rgba(0,255,180,0.06); color: var(--text);
    padding: 10px 12px; border-radius: 12px;
    font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase;
    box-shadow: 0 0 18px rgba(0,255,180,0.10), inset 0 0 18px rgba(0,255,180,0.08);
  }
  .btn:active{ transform: scale(0.99); }

  .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px; }
  .card{
    position:relative;
    background: linear-gradient(180deg, rgba(12,8,22,0.85), rgba(8,5,16,0.75));
    border: 1px solid rgba(0,255,180,0.22);
    border-radius: 16px; padding: 14px;
    box-shadow: 0 0 22px rgba(0,255,180,0.10), 0 0 45px rgba(255,0,255,0.06);
    overflow:hidden;
  }
  .card:after{
    content:""; position:absolute; top:-40px; right:-40px; width:120px; height:120px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,180,0.55), transparent 60%);
    transform: rotate(20deg); opacity:0.18;
  }
  .title{ font-weight:900; letter-spacing:0.8px; text-transform:uppercase; }
  .muted{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }

  .pill{
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
    letter-spacing:0.8px; text-transform:uppercase;
    border: 1px solid rgba(0,255,180,0.30);
    background: rgba(0,255,180,0.06);
    box-shadow: inset 0 0 12px rgba(0,255,180,0.10);
  }
  .ok{ color: var(--neonA); border-color: rgba(0,255,180,0.45) !important; }
  .warn{ color: var(--warn); border-color: rgba(255,224,102,0.45) !important; }
  .bad{ color: var(--bad); border-color: rgba(255,77,109,0.45) !important; }

  .big{
    font-size:46px; font-weight:950; letter-spacing:-1px; line-height:1;
    text-shadow: 0 0 18px rgba(0,255,180,0.18), 0 0 28px rgba(0,170,255,0.12);
  }
  .bar{
    height:12px; background: rgba(0,255,180,0.08); border: 1px solid rgba(0,255,180,0.20);
    border-radius:999px; overflow:hidden; margin-top:10px;
    box-shadow: inset 0 0 18px rgba(0,255,180,0.08);
  }
  .fill{
    height:100%; width:0%;
    background: linear-gradient(90deg, rgba(0,255,180,1), rgba(0,170,255,1), rgba(255,0,255,1));
    box-shadow: 0 0 18px rgba(0,255,180,0.25);
  }

  .indGrid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
  @media(min-width:700px){ .indGrid{ grid-template-columns: 1fr 1fr; } }
  .indCard{
    background: rgba(0,255,180,0.04);
    border: 1px solid rgba(0,255,180,0.18);
    border-radius: 14px; padding: 12px;
    box-shadow: inset 0 0 18px rgba(0,255,180,0.06);
  }
  .indTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
  .indName{ font-weight:900; letter-spacing:0.6px; text-transform:uppercase; }
  .indVal{ font-weight:950; }
  .indSub{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
  .indBar{
    height:10px; background: rgba(0,255,180,0.08); border: 1px solid rgba(0,255,180,0.18);
    border-radius:999px; overflow:hidden; margin-top:10px;
  }
  .indFill{
    height:100%; width:0%;
    background: linear-gradient(90deg, #00ffb4, #00aaff, #ff00ff);
    box-shadow: 0 0 16px rgba(255,0,255,0.10);
  }

  .hr{ margin-top:10px; height:1px; background: linear-gradient(90deg, transparent, rgba(0,255,180,0.25), transparent); }
  .log{
    font-size:12px;
    color:rgba(220,255,245,0.78);
    background:rgba(0,0,0,0.25);
    border:1px solid rgba(0,255,180,0.14);
    border-radius:12px;
    padding:10px;
    margin-top:10px;
    white-space:pre-wrap;
    line-height:1.35;
  }
</style>
</head>
<body>
<div class="gridBg"></div>

<div class="wrap">
  <div class="row">
    <div>
      <h1>NEON TENSION // USA ↔ IRAN</h1>
      <div class="small">
        One-page indicators (0–100) → Main Index (0–100) • Live from GDELT • Auto refresh optional
      </div>
    </div>
    <button class="btn" onclick="loadAll()">REFRESH</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <div class="title">MAIN TENSION INDEX</div>
          <div class="muted">Weighted blend of all indicators below</div>
        </div>
        <div class="pill" id="label">LOADING…</div>
      </div>

      <div style="margin-top:10px" class="big">
        <span id="score">--</span><span style="font-size:16px;font-weight:900;color:var(--muted)">/100</span>
      </div>
      <div class="bar"><div class="fill" id="mainFill"></div></div>

      <div class="hr"></div>
      <div class="muted" style="margin-top:10px" id="explain">DRIVERS: …</div>
      <div class="muted" style="margin-top:6px" id="riseDays">DAYS IN RISING TENSION: --</div>
      <div class="muted" style="margin-top:6px;color:var(--muted2)" id="statusLine">STATUS: …</div>
      <div class="log" id="logBox">LOG: ready</div>
    </div>

    <div class="card">
      <div class="title">ALL INDICATORS</div>
      <div class="muted" id="queryLine">QUERY: …</div>
      <div class="indGrid" id="indicators"></div>
    </div>

    <div class="card">
      <div class="title">LATEST HEADLINES</div>
      <div class="muted">Live top matches (GDELT ArtList)</div>
      <div class="log" id="headlineBox">Headlines loading…</div>
    </div>
  </div>
</div>

<script>
  // ===== SETTINGS YOU CAN EDIT =====
  const CORE_QUERY = '"United States" Iran';

  // Buckets (news-based) that influence tension
  const BUCKETS = [
    { key:"volume",   name:"NEWS VOLUME",           desc:"Public attention level",             weight:0.16 },
    { key:"trend",    name:"NEWS TREND",            desc:"7d vs prior 7d",                     weight:0.10 },
    { key:"spike",    name:"ATTENTION SPIKE",       desc:"3d surge vs prior week",            weight:0.10 },

    { key:"escalate", name:"ESCALATION LANGUAGE",   desc:"strike/missile/drone/attack",       weight:0.16,
      kws:["strike","retaliation","missile","drone","airstrike","attack","bombardment"] },

    { key:"nuclear",  name:"NUCLEAR PRESSURE",      desc:"IAEA/enrichment/uranium",           weight:0.14,
      kws:["IAEA","enrichment","uranium","nuclear","centrifuge","JCPOA"] },

    { key:"sanction", name:"SANCTIONS PRESSURE",    desc:"OFAC/sanctions/designations",       weight:0.12,
      kws:["sanction","OFAC","Treasury","designated","designation","blacklist"] },

    { key:"spill",    name:"REGIONAL SPILLOVER",    desc:"proxy/rocket/Red Sea",              weight:0.12,
      kws:["militia","rocket","proxy","Red Sea","Houthis","Hezbollah","Syria","Iraq"] },

    // diplomacy reduces tension → we invert it (100 - talksScore)
    { key:"diplomacy",name:"DIPLOMACY (INVERSE)",   desc:"more talks = lower tension",        weight:0.10,
      kws:["talks","negotiations","diplomacy","agreement","deal","dialogue","ceasefire"], invert:true },
  ];

  const AUTO_REFRESH = true;
  const REFRESH_MS = 5 * 60 * 1000;
  const SOURCELANG = "eng"; // keep stable for now
  const MAX_HEADLINES = 10;

  // ===== HELPERS =====
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function avg(arr){ return arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length); }
  function nowStr(){ return new Date().toLocaleString(); }
  function demo(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function labelFor(s){
    if(s<25) return ["LOW","ok"];
    if(s<50) return ["GUARDED","warn"];
    if(s<75) return ["ELEVATED","warn"];
    return ["HIGH","bad"];
  }
  function daysInRising(history){
    let d = 0;
    for(let i=history.length-1; i>0; i--){
      if(history[i] >= history[i-1]) d++;
      else break;
    }
    return d;
  }

  function log(lines){
    document.getElementById("logBox").textContent = `LOG @ ${nowStr()}\n` + lines.join("\n");
  }

  // ===== GDELT =====
  async function gdeltTimeline(query){
    const q = encodeURIComponent(query + ` sourcelang:${SOURCELANG}`);
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${q}&mode=timeline&format=json&timelinesmooth=0`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("GDELT_TIMELINE_FAILED");
    const j = await res.json();
    const tl = j.timeline || [];
    return tl.map(x => ({date:x.date, value:x.value})).slice(-30);
  }

  async function gdeltArtList(query){
    const q = encodeURIComponent(query + ` sourcelang:${SOURCELANG}`);
    // ArtList is easiest; even if it returns HTML sometimes, JSON is widely supported
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${q}&mode=artlist&format=json&sort=hybridrel&maxrecords=${MAX_HEADLINES}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("GDELT_ARTLIST_FAILED");
    const j = await res.json();
    return j.articles || [];
  }

  function trendPct(days){
    const vals = days.map(d=>d.value);
    const last7 = vals.slice(-7);
    const prev7 = vals.slice(-14,-7);
    const a = avg(last7), b = avg(prev7);
    if(!isFinite(a)||!isFinite(b)||b===0) return 0;
    return ((a-b)/b)*100;
  }

  function scoreVolume(v){ return Math.round(clamp((v - 10) / 190, 0, 1) * 100); }
  function scoreTrend(p){ return Math.round(clamp((p + 50) / 150, 0, 1) * 100); }
  function scoreSpike(days){
    const vals = days.map(d=>d.value);
    const last3 = vals.slice(-3);
    const prev7 = vals.slice(-10,-3);
    const a = avg(last3), b = avg(prev7);
    if(!isFinite(a)||!isFinite(b)||b===0) return 0;
    const pct = ((a-b)/b)*100;
    return Math.round(clamp(pct/150, 0, 1) * 100);
  }

  async function keywordPressure(coreQuery, kwList, scaleTop){
    const kwQuery = `${coreQuery} (${kwList.map(k=>`"${k}"`).join(" OR ")})`;
    const days = await gdeltTimeline(kwQuery);
    const today = days.length ? days[days.length-1].value : 0;
    const score = Math.round(clamp(today/scaleTop, 0, 1) * 100);
    return {score, today};
  }

  // ===== UI RENDER =====
  function renderIndicator(container, ind){
    const el = document.createElement("div");
    el.className = "indCard";
    el.innerHTML = `
      <div class="indTop">
        <div>
          <div class="indName">${ind.name} <span style="color:var(--muted2)">[${ind.status}]</span></div>
          <div class="indSub">${ind.desc}</div>
        </div>
        <div class="indVal">${ind.value}/100</div>
      </div>
      <div class="indBar"><div class="indFill" style="width:${ind.value}%"></div></div>
      <div class="indSub" style="margin-top:8px;color:rgba(220,255,245,.78)">${ind.detail}</div>
    `;
    container.appendChild(el);
  }

  function computeMain(indicators){
    let w=0, s=0;
    for(const i of indicators){ w += i.weight; s += i.value*i.weight; }
    return w ? Math.round(s/w) : 0;
  }

  // ===== MAIN LOAD =====
  async function loadAll(){
    document.getElementById("queryLine").textContent = "QUERY: " + CORE_QUERY;
    document.getElementById("statusLine").textContent = "STATUS: LOADING…";

    const listEl = document.getElementById("indicators");
    listEl.innerHTML = "";

    const notes = [];
    const inds = [];

    // Core timeline (drives volume/trend/spike + rising days)
    let coreDays = null;
    try{
      coreDays = await gdeltTimeline(CORE_QUERY);
      const volNow = coreDays.length ? coreDays[coreDays.length-1].value : 0;
      const tPct = trendPct(coreDays);
      const spike = scoreSpike(coreDays);

      // Rising days from volume history (stable + understandable)
      const hist = coreDays.map(d => scoreVolume(d.value));
      document.getElementById("riseDays").textContent = `DAYS IN RISING TENSION: ${daysInRising(hist)}`;

      // Add to indicator list
      inds.push({name:"NEWS VOLUME", desc:"Public attention level", value:scoreVolume(volNow), weight:0.16, status:"LIVE",
        detail:`today ≈ ${volNow} (timeline units)`});

      inds.push({name:"NEWS TREND", desc:"7d vs prior 7d", value:scoreTrend(tPct), weight:0.10, status:"LIVE",
        detail:`trend ${(tPct>=0?"+":"")}${tPct.toFixed(0)}%`});

      inds.push({name:"ATTENTION SPIKE", desc:"3d surge vs prior week", value:spike, weight:0.10, status:"LIVE",
        detail:`surge score from volume jump`});

      notes.push("core: LIVE OK");
    }catch(e){
      // Still show them, always
      document.getElementById("riseDays").textContent = "DAYS IN RISING TENSION: (demo)";
      inds.push({name:"NEWS VOLUME", desc:"Public attention level", value:demo(25,75), weight:0.16, status:"DEMO",
        detail:`live blocked`});
      inds.push({name:"NEWS TREND", desc:"7d vs prior 7d", value:demo(20,80), weight:0.10, status:"DEMO",
        detail:`live blocked`});
      inds.push({name:"ATTENTION SPIKE", desc:"3d surge vs prior week", value:demo(10,70), weight:0.10, status:"DEMO",
        detail:`live blocked`});
      notes.push("core: DEMO (GDELT blocked)");
    }

    // Keyword buckets (each independent)
    async function addBucket(b){
      if(!b.kws){
        // already handled by core (volume/trend/spike)
        return;
      }
      try{
        const r = await keywordPressure(CORE_QUERY, b.kws, 80);
        let val = r.score;
        if(b.invert) val = 100 - val;
        inds.push({name:b.name, desc:b.desc, value:val, weight:b.weight, status:"LIVE",
          detail:`keywords today ≈ ${r.today}`});
        notes.push(`${b.key}: LIVE OK`);
      }catch(e){
        inds.push({name:b.name, desc:b.desc, value:demo(10,85), weight:b.weight, status:"DEMO",
          detail:`live blocked`});
        notes.push(`${b.key}: DEMO`);
      }
    }

    // Add remaining buckets (skip the first 3 which are handled)
    for(const b of BUCKETS){
      if(["volume","trend","spike"].includes(b.key)) continue;
      await addBucket(b);
    }

    // Render all indicators
    inds.forEach(i => renderIndicator(listEl, i));

    // Main index
    const main = computeMain(inds);
    const [lbl, cls] = labelFor(main);
    const labelEl = document.getElementById("label");
    labelEl.textContent = lbl;
    labelEl.className = "pill " + cls;

    document.getElementById("score").textContent = main;
    document.getElementById("mainFill").style.width = main + "%";

    // Drivers
    const contrib = inds.map(i=>({name:i.name, pts:i.value*i.weight}))
      .sort((a,b)=>b.pts-a.pts);
    document.getElementById("explain").textContent = `DRIVERS: ${contrib[0].name} + ${contrib[1].name}`;

    // Headlines (independent)
    try{
      const arts = await gdeltArtList(CORE_QUERY);
      if(!arts.length){
        document.getElementById("headlineBox").textContent = "No headlines returned.";
      }else{
        const lines = arts.map(a => `• ${a.title || "Untitled"}\n  ${a.url || ""}`).join("\n\n");
        document.getElementById("headlineBox").textContent = lines;
      }
      notes.push("headlines: LIVE OK");
    }catch(e){
      document.getElementById("headlineBox").textContent =
        "Headlines blocked on this network. (Indicators still work.)";
      notes.push("headlines: DEMO");
    }

    // Status + log
    const degraded = inds.some(i=>i.status==="DEMO");
    document.getElementById("statusLine").textContent =
      degraded ? `STATUS: PARTIAL LIVE (some blocked) • UPDATED ${nowStr()}`
               : `STATUS: LIVE OK • UPDATED ${nowStr()}`;

    log(notes);
  }

  loadAll();
  if(AUTO_REFRESH) setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>